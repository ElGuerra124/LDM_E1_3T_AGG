const data = [
    {
        "CIF": "B0231535372",
        "NOMBRE": "HERNANDEZ Y ATENCIA SL",
        "CUPS": "ES002100000358263FN",
        "TARIFA": "6.1TD",
        "COMERCIALIZADORA": "EVOLVE",
        "COMERCIAL": "FRAN VILLAROBLEDO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "SE LE HA HECHO CAMBIO DE POTENCIA",
        "FECHA": "15-Nov"
    },
    {
        "CIF": "B16993131",
        "NOMBRE": "TE COMPRO Y PUNTO SL",
        "CUPS": "ES0021000004888369LS",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "FIRMADO",
        "FECHA": "21-Nov",
        "PAGADO": 60,
        "O 50%": 30
    },
    {
        "CIF": "52760917K",
        "NOMBRE": "MARIA DOLORES DOMINGUEZ",
        "CUPS": "ES0021000000394104RL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "FRAN VILLAROBLEDO",
        "ESTADO": "TRAMITADO",
        "FECHA": "15-Nov",
        "PAGADO": 35
    },
    {
        "CIF": "52760917K",
        "NOMBRE": "MARIA DOLORES DOMINGUEZ",
        "CUPS": "ES0220040039750113KK",
        "TARIFA": "RL1",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "FRAN VILLAROBLEDO",
        "ESTADO": "TRAMITADO",
        "FECHA": "15-Nov",
        "PAGADO": 25
    },
    {
        "CIF": "05247710F",
        "NOMBRE": "ROCIO GONZALEZ DOS SANTOS",
        "CUPS": "ES0315000011413712MD",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "CHUS",
        "ESTADO": "TRAMITADO",
        "FECHA": "15-Nov",
        "PAGADO": 35
    },
    {
        "CIF": "04854540E",
        "NOMBRE": "RAUL BARDERA MARTIN",
        "CUPS": "ES0021000001813732SH",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO"
    },
    {
        "CIF": "B04979373",
        "NOMBRE": "THINK ZERO SL",
        "CUPS": "ES0021000019532063QT",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B88443080",
        "NOMBRE": "BE BRAVE SL",
        "CUPS": "ES0031104407910004DN",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "TARIFA": "20TD",
        "COMERCIALIZADORA": "GANA ENERGIA",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "ACCIONES": "PAGADO"
    },
    {
        "CIF": "B87622195",
        "NOMBRE": "CAVEREL ASSETS SL",
        "CUPS": "ES0021000011732140TK",
        "TARIFA": "30TD",
        "COMERCIALIZADORA": "EVOLVE",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "PAGADO": 525.87,
        "O 50%": 262.93
    },
    {
        "CIF": "B82419335",
        "NOMBRE": "ROBLESFER SL",
        "CUPS": "ES0021000022413423BN",
        "TARIFA": "30TD",
        "COMERCIALIZADORA": "EVOLVE",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "PAGADO": 654.31,
        "O 50%": 327.15
    },
    {
        "CIF": "B88134615",
        "NOMBRE": "ROCKETFOOD SL",
        "CUPS": "ES0021000039244351TT",
        "TARIFA": "30TD",
        "COMERCIALIZADORA": "EVOLVE",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "PAGADO": 503.73,
        "O 50%": 251.86
    },
    {
        "CIF": "B80149986",
        "NOMBRE": "CASTELLANA GOLF ",
        "CUPS": "ES0021000020399272TV",
        "TARIFA": "30TD",
        "COMERCIALIZADORA": "EVOLVE",
        "COMERCIAL": "LUBO",
        "ESTADO": "TRAMITADO",
        "PAGADO": 403.35,
        "O 50%": 201.68
    }
];

async function searchData() {
    const cif = document.getElementById('search-cif').value;
    const nombre = document.getElementById('search-nombre').value;
    const comercializadora = document.getElementById('search-comercializadora').value;
    const estado = document.getElementById('search-estado').value;

    try {
        const response = await fetch(`http://localhost:3000/buscar?cif=${cif}&nombre=${nombre}&comercializadora=${comercializadora}&estado=${estado}`);
        const resultados = await response.json();

        const dataContainer = document.getElementById('data-container');
        dataContainer.innerHTML = '';

        if (resultados.length === 0) {
            dataContainer.innerHTML = '<p>No se encontraron resultados.</p>';
        } else {
            resultados.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('data-item');
                div.innerHTML = `
                    <p><strong>CIF:</strong> ${item.cif}</p>
                    <p><strong>Nombre:</strong> ${item.nombre}</p>
                    <p><strong>Comercializadora:</strong> ${item.comercializadora}</p>
                    <p><strong>Estado:</strong> ${item.estado}</p>
                `;
                dataContainer.appendChild(div);
            });
        }
        createChart(resultados);
    } catch (error) {
        console.error('Error al realizar la búsqueda:', error);
        const dataContainer = document.getElementById('data-container');
        dataContainer.innerHTML = '<p>Error al realizar la búsqueda. Intente nuevamente más tarde.</p>';
    }
}

function createChart(resultados) {
    const comercializadoraCount = resultados.reduce((acc, item) => {
        acc[item.comercializadora] = (acc[item.comercializadora] || 0) + 1;
        return acc;
    }, {});

    const ctx = document.getElementById('comercializadoraChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(comercializadoraCount),
            datasets: [{
                label: 'Comercializadoras',
                data: Object.values(comercializadoraCount),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    createChart(data); // Crear gráfica inicial con todos los datos
});

const container = document.getElementById('data-container');

function renderData(data) {
    container.innerHTML = '';
    data.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('data-item');
        itemElement.innerHTML = `
            <p><strong>CIF:</strong> ${item.CIF}</p>
            <p><strong>Nombre:</strong> ${item.NOMBRE}</p>
            <p><strong>CUPS:</strong> ${item.CUPS}</p>
            <p><strong>Tarifa:</strong> ${item.TARIFA}</p>
            <p><strong>Comercializadora:</strong> ${item.COMERCIALIZADORA}</p>
            <p><strong>Comercial:</strong> ${item.COMERCIAL}</p>
            <p><strong>Estado:</strong> ${item.ESTADO}</p>
            <p><strong>Acciones:</strong> ${item.ACCIONES}</p>
            <p><strong>Fecha:</strong> ${item.FECHA}</p>
            <p><strong>Pagado:</strong> ${item.PAGADO}</p>
            <p><strong>50%:</strong> ${item["O 50%"]}</p>
        `;
        container.appendChild(itemElement);
    });
}

function searchData() {
    const cif = document.getElementById('search-cif').value.toLowerCase();
    const nombre = document.getElementById('search-nombre').value.toLowerCase();
    const comercializadora = document.getElementById('search-comercializadora').value.toLowerCase();
    const estado = document.getElementById('search-estado').value.toLowerCase();

    const filteredData = data.filter(item => {
        return (
            (!cif || item.CIF.toLowerCase().includes(cif)) &&
            (!nombre || item.NOMBRE.toLowerCase().includes(nombre)) &&
            (!comercializadora || item.COMERCIALIZADORA.toLowerCase().includes(comercializadora)) &&
            (!estado || item.ESTADO.toLowerCase().includes(estado))
        );
    });

    renderData(filteredData);
}

renderData(data);